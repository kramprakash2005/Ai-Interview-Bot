<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Interview - Participant Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#6366f1',
            'primary-dark': '#4f46e5',
            'accent': '#ec4899',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .is-listening .recording-indicator {
      display: flex !important;
      animation: float 1.5s ease-in-out infinite;
    }
    .is-listening #question-box {
      animation: pulse-glow 2s infinite;
      border-color: #ef4444;
    }
    .view-content { display: none !important; }
    .view-active { display: block !important; animation: slideUp 0.4s ease-out; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-6">
  
  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

  <div class="w-full max-w-5xl glass-effect rounded-3xl shadow-2xl p-8 md:p-12">
    
    <!-- Header -->
    <div class="text-center mb-8">
      <!-- Logo intentionally removed here -->
      <h1 class="text-4xl font-extrabold text-gray-800 mb-2">AI Interview Portal</h1>
      <p id="session-job-title" class="text-xl font-semibold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">Loading...</p>
    </div>

    <!-- VIEW 1: Details Form -->
    <div id="view-details" class="view-content view-active">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center mb-6">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-xl flex items-center justify-center mr-3">
            <span class="text-white font-bold">1</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Your Information</h2>
        </div>
        
        <p class="text-gray-600 mb-6">Please provide your details before starting the interview</p>
        <div id="details-error" class="hidden bg-red-50 border-2 border-red-200 text-red-600 p-4 rounded-xl mb-4 font-medium"></div>

        <div class="space-y-4">
          <input id="p-name" placeholder="Full Name *" type="text" 
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-0 outline-none transition-all"/>
          <input id="p-phone" placeholder="Phone Number (Optional)" type="tel" 
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-0 outline-none transition-all"/>
          <textarea id="p-other" placeholder="Additional details (Optional)" rows="3" 
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-0 outline-none transition-all"></textarea>
        </div>

        <button id="next-to-test-btn" class="w-full mt-6 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
          Continue to Equipment Test <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>
    </div>

    <!-- VIEW 2: Equipment Test -->
    <div id="view-test" class="view-content">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center mb-6">
          <div class="w-10 h-10 bg-gradient-to-br from-accent to-pink-600 rounded-xl flex items-center justify-center mr-3">
            <span class="text-white font-bold">2</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Equipment Check</h2>
        </div>
        
        <p class="text-gray-600 mb-6">Test your audio equipment before starting</p>
        
        <!-- Speaker Test -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl mb-6 border-2 border-blue-200">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center mb-2">
                <i class="fas fa-volume-up text-primary text-xl mr-3"></i>
                <strong class="text-lg text-gray-800">Speaker Test</strong>
              </div>
              <p class="text-sm text-gray-600 mb-3">Click to play a test sound</p>
              <button id="test-audio-btn" class="px-6 py-3 bg-gradient-to-r from-primary to-primary-dark text-white rounded-xl hover:shadow-lg transition-all font-semibold">
                <i class="fas fa-play mr-2"></i> Play Test Sound
              </button>
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="speaker-check" class="w-6 h-6 text-green-600 rounded focus:ring-0" />
              <label for="speaker-check" class="ml-3 text-gray-700 font-medium">I heard it</label>
            </div>
          </div>
        </div>

        <!-- Microphone Test -->
        <div class="bg-gradient-to-br from-red-50 to-orange-50 p-6 rounded-2xl mb-6 border-2 border-red-200">
          <div class="flex items-center mb-4">
            <i class="fas fa-microphone text-red-600 text-xl mr-3"></i>
            <strong class="text-lg text-gray-800">Microphone Test</strong>
          </div>
          
          <div id="mic-test-status" class="text-sm font-medium text-gray-700 mb-4 p-3 bg-white/50 rounded-lg">
            Status: Ready to test microphone
          </div>
          
          <div class="flex gap-3 mb-4">
            <button id="start-mic-test-btn" class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-xl hover:shadow-lg transition-all">
              <i class="fas fa-microphone mr-2"></i> Start Test
            </button>
            <button id="stop-mic-test-btn" class="px-6 py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition-all" style="display:none;">
              <i class="fas fa-stop mr-2"></i> Stop
            </button>
          </div>
          
          <div class="bg-white border-2 border-gray-200 rounded-xl p-4 mb-4">
            <p class="text-xs text-gray-500 mb-2">Live Transcription:</p>
            <div id="mic-test-transcript" class="text-gray-700 min-h-[60px] italic">
              Your speech will appear here...
            </div>
          </div>

          <div class="flex items-center">
            <input type="checkbox" id="mic-check" class="w-6 h-6 text-green-600 rounded focus:ring-0" disabled />
            <label for="mic-check" class="ml-3 text-gray-700 font-medium">My speech was transcribed correctly</label>
          </div>
        </div>
        
        <button id="next-to-interview-btn" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-lg rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>
          <i class="fas fa-check-circle mr-2"></i> Start Interview
        </button>
      </div>
    </div>

    <!-- VIEW 3: Interview -->
    <div id="view-interview" class="view-content">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center pb-6 border-b-2 border-gray-200 mb-8">
        <div>
          <h2 id="interview-title" class="text-3xl font-bold text-gray-800">Interview in Progress</h2>
          <div class="text-gray-600 mt-1">
            Candidate: <span id="participant-name" class="font-semibold text-gray-800">Participant</span>
          </div>
        </div>
        <div class="mt-4 md:mt-0 flex items-center bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl shadow-lg">
          <i class="fas fa-clock mr-2"></i> 
          <span id="remaining-time" class="font-bold text-xl">--:--</span>
        </div>
      </div>

      <!-- Recording Indicator (Hidden by default) -->
      <div class="recording-indicator hidden justify-center mb-6">
        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center">
          <div class="w-4 h-4 bg-white rounded-full mr-3 animate-pulse"></div>
          <span class="font-bold text-lg">RECORDING</span>
        </div>
      </div>

      <!-- Question Box -->
      <div id="question-box" class="min-h-[200px] flex flex-col items-center justify-center text-center p-8 bg-gradient-to-br from-indigo-50 to-purple-50 border-4 border-primary/30 rounded-2xl shadow-inner mb-8 transition-all">
        <p id="question-text" class="text-2xl md:text-3xl font-bold text-gray-800">
          Click 'Start Interview' to begin
        </p>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-3 justify-center mb-8">
        <button id="start-btn" class="px-8 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold text-lg rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all">
          <i class="fas fa-play mr-2"></i> Start Interview
        </button>
        
        <button id="stop-btn" class="px-8 py-4 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold text-lg rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all" style="display:none">
          <i class="fas fa-stop mr-2"></i> Stop & Submit
        </button>
        
        <button id="rerecord-btn" class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all" style="display:none">
          <i class="fas fa-redo mr-2"></i> Re-record
        </button>
        
        <button id="repeat-btn" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-all" disabled>
          <i class="fas fa-volume-up mr-2"></i> Repeat
        </button>
        
        <button id="skip-btn" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-all" disabled>
          <i class="fas fa-forward mr-2"></i> Skip
        </button>

        <button id="end-test-btn" class="px-6 py-3 bg-gradient-to-r from-gray-700 to-gray-800 text-white font-semibold rounded-xl hover:shadow-lg transition-all">
          <i class="fas fa-flag-checkered mr-2"></i> End Test
        </button>
      </div>

      <!-- Transcript Box -->
      <div class="bg-gradient-to-br from-gray-50 to-indigo-50 border-2 border-gray-200 rounded-2xl p-6 min-h-[150px]">
        <div class="flex items-center mb-3">
          <i class="fas fa-file-lines text-primary mr-2"></i>
          <p class="font-semibold text-gray-800">Your Answer:</p>
        </div>
        <div id="answer-box" class="text-gray-600 italic whitespace-pre-wrap">
          Transcript will appear here...
        </div>
      </div>
    </div>

    <!-- VIEW 4: Complete -->
    <div id="view-complete" class="view-content text-center">
      <div class="max-w-2xl mx-auto">
        <div class="bg-gradient-to-br from-green-400 to-emerald-500 w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-8 shadow-2xl">
          <i class="fas fa-check text-6xl text-white"></i>
        </div>
        
        <h2 id="complete-heading" class="text-4xl font-bold text-gray-800 mb-4">Interview Complete!</h2>
        <p class="text-xl text-gray-600 mb-8">
          Thank you for participating. Your responses have been submitted successfully.
        </p>
        
        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-8 rounded-2xl border-2 border-indigo-200">
          <i class="fas fa-info-circle text-primary text-2xl mb-3"></i>
          <p class="text-gray-700">You may now close this window</p>
        </div>
      </div>
    </div>

  </div>

<script>
const API_BASE = "http://localhost:8000"; 
let currentView = 'details';

const PROCTOR_CONFIG = {
    MAX_VIOLATIONS: 5, // Maximum allowed focus/tab violations before termination
    LOG_UPLOAD_INTERVAL_MS: 30000, // Upload logs every 30 seconds
};

function showToast(message, type = 'error') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  
  let bgColor, icon;
  if (type === 'error') {
    bgColor = 'bg-gradient-to-r from-red-500 to-red-600';
    icon = '‚ö†Ô∏è';
  } else if (type === 'warning') {
    bgColor = 'bg-gradient-to-r from-yellow-500 to-orange-500';
    icon = 'üîî';
  } else if (type === 'success') {
    bgColor = 'bg-gradient-to-r from-green-500 to-emerald-600';
    icon = '‚úì';
  } else {
    bgColor = 'bg-gradient-to-r from-blue-500 to-indigo-600';
    icon = '‚ÑπÔ∏è';
  }

  toast.className = `p-4 mb-2 rounded-xl text-white shadow-2xl transition-all duration-500 transform translate-x-full opacity-0 ${bgColor}`;
  toast.style.maxWidth = '320px';
  toast.innerHTML = `<div class="flex items-center"><span class="text-2xl mr-3">${icon}</span><span class="font-semibold">${message}</span></div>`;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.remove('translate-x-full', 'opacity-0');
    toast.classList.add('translate-x-0', 'opacity-100');
  }, 10);

  setTimeout(() => {
    toast.classList.remove('translate-x-0', 'opacity-100');
    toast.classList.add('translate-x-full', 'opacity-0');
    toast.addEventListener('transitionend', () => toast.remove());
  }, 4000);
}


function qs(name) {
  const p = new URLSearchParams(window.location.search);
  return p.get(name);
}

const token = qs('token');
const participant_id = qs('participant_id');
const session_id = qs('session_id');

const state = {
  questions: [],
  qIndex: -1,
  recognition: null,
  isListening: false,
  remainingSeconds: 0,
  timerInterval: null,
  participantToken: token,
  audio: new Audio(),
  micTestInProgress: false,
  proctorLogs: [],       // Array to store logs before bulk upload
  violationCount: 0,     // Counter for focus/tab violations
  logUploadInterval: null,
  isTerminating: false,  // Flag to prevent logging during termination
};

const dom = {
  body: document.body, 
  allViews: {
    details: document.getElementById('view-details'),
    test: document.getElementById('view-test'),
    interview: document.getElementById('view-interview'),
    complete: document.getElementById('view-complete')
  },
  sessionTitle: document.getElementById('session-job-title'),
  detailsError: document.getElementById('details-error'),
  pName: document.getElementById('p-name'),
  pPhone: document.getElementById('p-phone'),
  pOther: document.getElementById('p-other'),
  nextToTestBtn: document.getElementById('next-to-test-btn'),
  testAudioBtn: document.getElementById('test-audio-btn'),
  speakerCheck: document.getElementById('speaker-check'),
  micTestTranscript: document.getElementById('mic-test-transcript'),
  micTestStatus: document.getElementById('mic-test-status'),
  startMicTestBtn: document.getElementById('start-mic-test-btn'),
  stopMicTestBtn: document.getElementById('stop-mic-test-btn'),
  micCheck: document.getElementById('mic-check'),
  nextToInterviewBtn: document.getElementById('next-to-interview-btn'),
  questionBox: document.getElementById('question-box'),
  questionText: document.getElementById('question-text'),
  startBtn: document.getElementById('start-btn'),
  stopBtn: document.getElementById('stop-btn'),
  rerecordBtn: document.getElementById('rerecord-btn'),
  repeatBtn: document.getElementById('repeat-btn'),
  skipBtn: document.getElementById('skip-btn'),
  endTestBtn: document.getElementById('end-test-btn'),
  answerBox: document.getElementById('answer-box'),
  remainingTime: document.getElementById('remaining-time'),
  interviewTitle: document.getElementById('interview-title'),
  participantNameDisplay: document.getElementById('participant-name')
};

// --- API Helpers ---
async function apiPost(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const txt = await res.text().catch(()=>'');
    let msg = `API error ${res.status}`;
    try { msg += `: ${JSON.parse(txt).detail}`; } catch(e) { msg += ` (${txt})`; }
    throw new Error(msg);
  }
  return res.json();
}

async function apiGet(path) {
    const res = await fetch(API_BASE + path);
    if (!res.ok) throw new Error(`API error ${res.status}`);
    return res.json();
}

// --- View Switching ---
function showView(viewName) {
    if (!dom.allViews[viewName]) return;
    currentView = viewName;
    Object.keys(dom.allViews).forEach(key => {
        dom.allViews[key].classList.remove('view-active');
    });
    dom.allViews[viewName].classList.add('view-active');
}

// --- General Functions ---

function updateRemainingTimeDisplay(){
  const m = Math.floor(state.remainingSeconds/60);
  const s = state.remainingSeconds%60;
  dom.remainingTime.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function speak(text){
  return new Promise((resolve)=>{
    if (!('speechSynthesis' in window)) return resolve();
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'en-US';
    ut.rate = 1; 
    ut.pitch = 1;
    ut.onend = () => resolve();
    ut.onerror = () => resolve();
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  });
}

// --- Proctoring Logic ---

function logProctorViolation(type, detail, severity='warning'){
    if (state.isTerminating) return; // Stop logging if we are ending the session

    const log = {
        type: type,
        detail: detail,
        timestamp: new Date().toISOString(),
        severity: severity,
        question_id: state.questions[state.qIndex]?.id || 'PRE_TEST',
    };
    state.proctorLogs.push(log);
    console.warn(`[PROCTOR] ${type}: ${detail}`);

    // Check for focus/tab violation limits
    if (type === 'FOCUS_LOST' || type === 'TAB_SWITCH') {
        state.violationCount++;
        checkViolationLimit();
    }
}

async function uploadProctorLogs() {
    if (state.proctorLogs.length === 0) return;

    // Use a copy of the logs and clear the primary array immediately
    const logsToSend = [...state.proctorLogs];
    state.proctorLogs = []; 

    try {
        await apiPost('/api/proctor/logs', {
            participant_id: participant_id,
            logs: logsToSend
        });
    } catch (e) {
        // If upload fails, merge the unsent logs back into the array
        console.error("Failed to upload proctor logs. Merging back.", e);
        state.proctorLogs.push(...logsToSend);
    }
}

function startProctoringUploader() {
    if (state.logUploadInterval) clearInterval(state.logUploadInterval);
    state.logUploadInterval = setInterval(uploadProctorLogs, PROCTOR_CONFIG.LOG_UPLOAD_INTERVAL_MS);
}

function checkViolationLimit() {
    if (state.violationCount === 1) {
        showToast("Warning: Please remain focused on the interview window.", 'warning');
    } else if (state.violationCount > 1 && state.violationCount < PROCTOR_CONFIG.MAX_VIOLATIONS) {
        showToast(`Violation detected! Limit: ${state.violationCount}/${PROCTOR_CONFIG.MAX_VIOLATIONS}`, 'warning');
    } else if (state.violationCount >= PROCTOR_CONFIG.MAX_VIOLATIONS) {
        showToast("Maximum violations reached. Interview is being terminated.", 'error');
        logProctorViolation('SESSION_TERMINATED', 'Maximum focus/tab violations reached.', 'error');
        // Delay termination slightly to allow the final log to queue up
        setTimeout(() => completeInterviewFlow(false, 'TERMINATED'), 500);
    }
}


// --- Event Listeners for Proctoring Activation ---

function setupProctoringEvents() {
    // 1. Focus/Tab Switching Detection
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden' && !state.isTerminating) {
            logProctorViolation('TAB_SWITCH', 'Participant switched tabs/minimized window.');
        } else if (document.visibilityState === 'visible' && !state.isTerminating) {
            logProctorViolation('FOCUS_RETURN', 'Participant returned to interview window.');
        }
    });

    window.addEventListener('blur', () => {
        if (!state.isTerminating && document.visibilityState === 'visible') {
            // This detects losing focus without minimizing (e.g., clicking another app window)
            logProctorViolation('FOCUS_LOST', 'Browser window lost focus.', 'warning');
        }
    });
    
    // NEW: Fullscreen Exit Detection
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    // 2. Disabled Features (Right-Click, Copy/Paste, Dev Tools)
    window.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        logProctorViolation('RIGHT_CLICK', 'Attempted right-click menu access.', 'warning');
        showToast('Right-click is disabled during the interview.', 'warning');
    });

    window.addEventListener('keydown', (e) => {
        // Ctrl+C, Ctrl+V, Ctrl+Shift+I (Dev Tools), F12 (Dev Tools)
        const isControl = e.ctrlKey || e.metaKey; // metaKey for Command on Mac
        const isDevToolKey = (isControl && e.shiftKey && e.key === 'I') || e.key === 'F12';
        
        if ((isControl && (e.key === 'c' || e.key === 'v' || e.key === 'V' || e.key === 'C')) || isDevToolKey) {
            e.preventDefault();
            
            let type;
            if (e.key === 'c' || e.key === 'C') type = 'COPY_ATTEMPT';
            else if (e.key === 'v' || e.key === 'V') type = 'PASTE_ATTEMPT';
            else type = 'DEV_TOOL_ATTEMPT';

            logProctorViolation(type, `Blocked shortcut: ${e.code}`, 'warning');
            showToast(`Action blocked: Please do not use ${e.key === 'F12' ? 'Developer Tools' : 'Copy/Paste'}.`, 'warning');
        }
    });
}

function handleFullscreenChange() {
    const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
    
    if (currentView === 'interview' && !isFullscreen && !state.isTerminating) {
        logProctorViolation('FULLSCREEN_EXIT', 'Participant exited fullscreen mode.', 'error');
        showToast('You must remain in fullscreen mode. Re-entering fullscreen...', 'warning');
        
        // Attempt to re-request fullscreen (soft enforcement)
        try {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
            else if (el.msRequestFullscreen) el.msRequestFullscreen();
        } catch (e) {
            console.error("Failed to re-request fullscreen:", e);
        }
        
        // Check for violation limit immediately after exit
        state.violationCount++;
        checkViolationLimit();
    }
}


// --- Flow Control ---

async function completeInterviewFlow(isTimeout = false, terminationReason = 'COMPLETED') {
    if (state.isTerminating) return; // Prevent double termination
    state.isTerminating = true;

    clearInterval(state.timerInterval);
    if (state.logUploadInterval) clearInterval(state.logUploadInterval);
    
    // Stop recognition immediately
    if (state.isListening && state.recognition) {
        try { state.recognition.stop(); } catch(e) {}
    }
    
    // Exit fullscreen on completion/termination (if supported)
    if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
        try {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
            else if (document.msExitFullscreen) document.msExitFullscreen();
        } catch (e) {
            console.warn("Could not exit fullscreen gracefully:", e);
        }
    }
    
    // Perform final log upload synchronously if possible
    await uploadProctorLogs();
    
    dom.body.classList.remove('is-listening');
    dom.stopBtn.style.display = 'none';
    dom.startBtn.style.display = 'none';
    dom.rerecordBtn.style.display = 'none';

    dom.sessionTitle.textContent = "Finalizing...";
    
    // Mark as completed in backend
    try {
        await apiPost(`/api/participants/${participant_id}/complete`, {});
    } catch(e) {
        console.error("Completion endpoint failed:", e);
    }
    
    // Show completion view
    const completeHeadingEl = document.getElementById('complete-heading');
    const completeIcon = dom.allViews.complete.querySelector('i');
    const completeCircle = dom.allViews.complete.querySelector('.w-32');

    if (isTimeout) {
        completeHeadingEl.textContent = "Time Expired";
        completeIcon.classList.replace('fa-check', 'fa-hourglass-end');
        completeCircle.classList.replace('from-green-400', 'from-red-400');
        completeCircle.classList.replace('to-emerald-500', 'to-red-600');
    } else if (terminationReason === 'TERMINATED') {
        completeHeadingEl.textContent = "Test Terminated";
        completeHeadingEl.classList.add('text-red-600');
        completeIcon.classList.replace('fa-check', 'fa-exclamation-triangle');
        completeCircle.classList.replace('from-green-400', 'from-red-600');
        completeCircle.classList.replace('to-emerald-500', 'to-red-800');
    }
    
    showView('complete');
}


// ---------------- VIEW 1: DETAILS LOGIC ----------------

dom.nextToTestBtn.addEventListener('click', async () => {
    const name = dom.pName.value.trim();
    const phone = dom.pPhone.value.trim();
    const other = dom.pOther.value.trim();

    dom.detailsError.classList.add('hidden');

    if (!name) {
        dom.detailsError.textContent = 'Full Name is required';
        dom.detailsError.classList.remove('hidden');
        return;
    }
    
    dom.nextToTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
    dom.nextToTestBtn.disabled = true;

    try {
        await apiPost(`/api/participants/${participant_id}/profile`, {
            name: name,
            phone_number: phone || null,
            other_details: other || null
        });
        dom.participantNameDisplay.textContent = name;
        showView('test');
    } catch(e) {
        dom.detailsError.textContent = `Failed: ${e.message}`;
        dom.detailsError.classList.remove('hidden');
    } finally {
        dom.nextToTestBtn.innerHTML = 'Continue to Equipment Test <i class="fas fa-arrow-right ml-2"></i>';
        dom.nextToTestBtn.disabled = false;
    }
});

// ---------------- VIEW 2: TEST LOGIC ----------------

dom.testAudioBtn.addEventListener('click', () => {
    speak("This is a test of your speaker volume. If you hear this clearly, please check the box.");
});

let micTestRecognition = null;
let micTestAccumulatedTranscript = '';

function initializeMicTestRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        dom.micTestStatus.textContent = 'Error: Speech recognition not supported';
        dom.startMicTestBtn.disabled = true;
        return null;
    }
    micTestRecognition = new SpeechRecognition();
    micTestRecognition.interimResults = true;
    micTestRecognition.lang = 'en-US';
    micTestRecognition.continuous = true;
    
    micTestRecognition.onstart = () => {
        state.micTestInProgress = true;
        micTestAccumulatedTranscript = '';
        dom.micTestTranscript.textContent = 'Listening... Speak now';
        dom.micTestStatus.textContent = 'Status: Recording started';
        dom.startMicTestBtn.style.display = 'none';
        dom.stopMicTestBtn.style.display = 'inline-block';
    };

    micTestRecognition.onresult = (evt) => {
        let final = '';
        let interim = '';
        for (let i = evt.resultIndex; i < evt.results.length; i++) {
            const t = evt.results[i][0].transcript;
            if (evt.results[i].isFinal) final += t + ' ';
            else interim += t;
        }
        if (final) micTestAccumulatedTranscript += final;
        dom.micTestTranscript.textContent = micTestAccumulatedTranscript + interim;
    };

    micTestRecognition.onend = () => {
        state.micTestInProgress = false;
        dom.micTestStatus.textContent = 'Status: Test complete';
        dom.startMicTestBtn.style.display = 'inline-block';
        dom.stopMicTestBtn.style.display = 'none';
        dom.micCheck.disabled = false;
    };

    micTestRecognition.onerror = (e) => {
        state.micTestInProgress = false;
        dom.micTestStatus.textContent = `Error: ${e.error}`;
        dom.startMicTestBtn.style.display = 'inline-block';
        dom.stopMicTestBtn.style.display = 'none';
    };
    return micTestRecognition;
}

dom.startMicTestBtn.addEventListener('click', () => {
    if (!micTestRecognition) micTestRecognition = initializeMicTestRecognition();
    if (micTestRecognition && !state.micTestInProgress) micTestRecognition.start();
});

dom.stopMicTestBtn.addEventListener('click', () => {
    if (micTestRecognition && state.micTestInProgress) micTestRecognition.stop();
});

function updateTestButtonState() {
    const speakerOk = dom.speakerCheck.checked;
    const micOk = dom.micCheck.checked;
    dom.nextToInterviewBtn.disabled = !(speakerOk && micOk);
}
dom.speakerCheck.addEventListener('change', updateTestButtonState);
dom.micCheck.addEventListener('change', updateTestButtonState);

dom.nextToInterviewBtn.addEventListener('click', async () => {
    dom.nextToInterviewBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Starting...';
    dom.nextToInterviewBtn.disabled = true;
    
    try {
        // NEW: Request fullscreen immediately before starting session
        const el = document.documentElement;
        if (el.requestFullscreen) {
            await el.requestFullscreen();
        } else if (el.webkitRequestFullscreen) {
            await el.webkitRequestFullscreen();
        } else if (el.mozRequestFullScreen) {
            await el.mozRequestFullScreen();
        } else if (el.msRequestFullscreen) {
            await el.msRequestFullscreen();
        } else {
            // Log if fullscreen is not supported/possible
            logProctorViolation('FULLSCREEN_FAILED', 'Browser does not support fullscreen request.', 'info');
            showToast('Warning: Fullscreen mode is recommended but not supported by your browser.', 'warning');
        }
        
        const data = await apiPost(`/api/sessions/${session_id}/start`, { token });
        state.questions = data.questions || [];
        state.remainingSeconds = (data.time_limit_minutes || 60) * 60;
        
        const sessionInfo = await apiGet(`/api/sessions/${session_id}/info`);
        dom.sessionTitle.textContent = sessionInfo.title || 'Interview';
        
        // Start proctoring background upload right before starting the interview flow
        startProctoringUploader();
        setupProctoringEvents();

        showView('interview');
        updateRemainingTimeDisplay();
        startTimer();
        
        dom.startBtn.style.display = 'inline-block';
        dom.interviewTitle.textContent = dom.sessionTitle.textContent;
        
        initializeRecognition();
        
    } catch (e) {
        // Use custom alert polyfill
        window.alert(`Failed to start: ${e.message}`);
        dom.nextToInterviewBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Start Interview';
        dom.nextToInterviewBtn.disabled = false;
        
        // If a step failed (e.g., fullscreen permission denied), ensure we stop logging upload
        if (state.logUploadInterval) clearInterval(state.logUploadInterval);
    }
});

// ---------------- VIEW 3: INTERVIEW LOGIC ----------------

function startTimer(){
  if (state.timerInterval) return;
  state.timerInterval = setInterval(()=>{
    state.remainingSeconds--;
    updateRemainingTimeDisplay();
    if (state.remainingSeconds <= 0) completeInterviewFlow(true);
  }, 1000);
}

function initializeRecognition(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    dom.questionText.textContent = 'Speech recognition not supported in this browser';
    dom.startBtn.disabled = true;
    logProctorViolation('MIC_UNSUPPORTED', 'Web Speech API not found.', 'error');
    return;
  }
  state.recognition = new SpeechRecognition();
  state.recognition.interimResults = true;
  state.recognition.maxAlternatives = 1;
  state.recognition.lang = 'en-US';
  state.recognition.continuous = true; 
  
  let accumulatedTranscript = '';

  state.recognition.onresult = (evt) => {
    let final = '';
    let interim = '';
    for (let i = evt.resultIndex; i < evt.results.length; i++) {
      const t = evt.results[i][0].transcript;
      if (evt.results[i].isFinal) final += t + ' ';
      else interim += t;
    }
    if (final) accumulatedTranscript += final;
    dom.answerBox.textContent = accumulatedTranscript + interim;
  };
  
  state.recognition.onstart = () => {
    accumulatedTranscript = '';
    dom.body.classList.add('is-listening');
  }
  
  state.recognition.onerror = (e) => {
    if (state.isListening && e.error !== 'no-speech') {
        logProctorViolation('MIC_ERROR', `Recognition error: ${e.error}`, 'error');
        stopListeningAndSave(false, true); 
        dom.questionText.innerHTML += '<p class="text-base font-bold text-red-600 mt-2">Recording interrupted! Click Next Question.</p>';
    } else if (e.error === 'no-speech' && state.isListening) {
        // Attempt to restart if no speech is detected (common Chrome issue)
        logProctorViolation('MIC_SILENCE', 'No speech detected, recognition restarting.', 'info');
        state.recognition.stop();
        state.recognition.start();
    }
  };
  
  state.recognition.onend = () => {
    dom.body.classList.remove('is-listening');
    state.isListening = false;
    // If recognition ends unexpectedly while we expected to be listening, log it.
    if (currentView === 'interview' && !state.isTerminating && state.qIndex >= 0) {
        logProctorViolation('MIC_UNEXPECTED_STOP', 'Recognition ended unexpectedly (Microphone disconnect/system issue).', 'warning');
    }
  };
}

async function nextQuestion(){
  if (state.isListening && state.recognition){
    try { state.recognition.stop(); } catch(e){}
    state.isListening = false;
    dom.body.classList.remove('is-listening');
  }

  if (state.qIndex >= state.questions.length - 1){
    completeInterviewFlow();
    return;
  }
  
  state.qIndex++;
  const q = state.questions[state.qIndex];
  dom.questionText.innerHTML = `<span class="block text-base font-semibold text-primary mb-3">Question ${state.qIndex+1} of ${state.questions.length}</span>${q.text}`;
  dom.answerBox.textContent = 'Awaiting transcription...';
  
  dom.startBtn.style.display = 'none';
  dom.stopBtn.style.display = 'none';
  dom.rerecordBtn.style.display = 'none';
  dom.repeatBtn.disabled = true;
  dom.skipBtn.disabled = true;
  
  await speak(q.text);
  startListening();
}

function startListening(){
  if (!state.recognition) return;
  
  dom.answerBox.textContent = 'Recording: Speak now...';
  dom.answerBox.classList.add('font-bold', 'text-red-600', 'not-italic');

  state.isListening = true;
  state.recognition.start();
  
  dom.stopBtn.style.display = 'inline-block';
  dom.stopBtn.disabled = false;
  dom.startBtn.style.display = 'none'; 
  dom.rerecordBtn.style.display = 'none';
  dom.repeatBtn.disabled = false;
  dom.skipBtn.disabled = false;
  
  dom.body.classList.add('is-listening');
}

function stopListeningAndSave(isSkip=false, isError=false){
  if (state.isListening && state.recognition){
    try { state.recognition.stop(); } catch(e){}
    state.isListening = false;
    dom.body.classList.remove('is-listening');
  }
  
  dom.stopBtn.style.display = 'none';
  
  const q = state.questions[state.qIndex];
  if (!q) return; 

  let transcript = dom.answerBox.textContent.replace('Recording: Speak now...', '').trim() || '';
  if (isSkip) {
      transcript = '[SKIPPED]';
      logProctorViolation('QUESTION_SKIPPED', `Question ${state.qIndex + 1} skipped.`, 'info');
  }
  if (isError) transcript += ' [INTERRUPTED]';
  
  if (!transcript && !isSkip) {
      transcript = '[NO RESPONSE]'; 
      logProctorViolation('NO_RESPONSE', `Question ${state.qIndex + 1} ended with no response.`, 'warning');
  }
  
  const payload = {
    question_id: q.id,
    transcript: transcript,
    duration_seconds: null, 
    confidence: null
  };
  
  apiPost(`/api/participants/${participant_id}/answer`, payload)
  .catch(err=>console.error('Answer save failed:', err));
  
  dom.answerBox.textContent = transcript;
  dom.answerBox.classList.remove('font-bold', 'text-red-600', 'italic');
  dom.answerBox.classList.add('text-gray-700', 'font-medium', 'not-italic');
  
  dom.rerecordBtn.style.display = (isSkip || isError) ? 'none' : 'inline-block';
  dom.startBtn.style.display = 'inline-block'; 
  dom.startBtn.disabled = false;
  dom.startBtn.innerHTML = '<i class="fas fa-forward mr-2"></i> Next Question';
  dom.repeatBtn.disabled = false;
  dom.skipBtn.disabled = false;
  
  if (state.qIndex >= state.questions.length - 1){
    dom.startBtn.innerHTML = '<i class="fas fa-flag-checkered mr-2"></i> Complete';
  }
}

// --- Event Listeners ---
dom.startBtn.addEventListener('click', async () => {
  if (state.questions.length === 0 || state.qIndex === -1){
    // This button starts the first question
    await nextQuestion();
  } else if (state.qIndex >= state.questions.length - 1) {
    // If it's the last question and we click next, finish the interview
    completeInterviewFlow();
  } else {
    // Standard next question logic
    await nextQuestion();
  }
});

dom.stopBtn.addEventListener('click', () => {
  stopListeningAndSave(false);
});

dom.rerecordBtn.addEventListener('click', async () => {
  logProctorViolation('RERECORD', `Question ${state.qIndex + 1} re-recorded.`, 'info');

  dom.rerecordBtn.style.display = 'none';
  dom.startBtn.disabled = true;
  dom.startBtn.style.display = 'none';
  
  dom.answerBox.textContent = 'Awaiting transcription...';
  dom.answerBox.classList.remove('text-gray-700', 'font-medium', 'not-italic');
  dom.answerBox.classList.add('italic', 'text-gray-600');
  
  if (state.recognition && state.isListening) {
      try { state.recognition.stop(); } catch(e) {}
  }
  startListening();
});

dom.repeatBtn.addEventListener('click', () => { 
  if (state.qIndex === -1 || !state.questions[state.qIndex]) return;
  logProctorViolation('QUESTION_REPEAT', `Question ${state.qIndex + 1} repeated.`, 'info');
  speak(state.questions[state.qIndex].text);
});

dom.skipBtn.addEventListener('click', () => {
  stopListeningAndSave(true);
  nextQuestion();
});

dom.endTestBtn.addEventListener('click', () => {
    // Use custom confirm polyfill
    if (window.confirm("Are you sure you want to end the test early? Type 'yes' to confirm.")) {
        logProctorViolation('MANUAL_TERMINATION', 'Participant ended test manually.', 'info');
        completeInterviewFlow();
    }
});

// Polyfill for simple alert/confirm replacement
window.confirm = (message) => {
    return window.prompt(message + " Type 'yes' to confirm.") === 'yes';
};
window.alert = (message) => {
    console.log(message);
    prompt(message + " Click OK to continue."); 
};


// --- Initialization ---
document.addEventListener('DOMContentLoaded', async ()=>{
  if (!token || !participant_id || !session_id) {
    showView('details');
    dom.sessionTitle.textContent = 'Invalid Link';
    dom.nextToTestBtn.disabled = true;
    return;
  }
  
  dom.participantNameDisplay.textContent = participant_id.substring(0, 8) + '...';

  try {
      const sessionInfo = await apiGet(`/api/sessions/${session_id}/info`);
      dom.sessionTitle.textContent = sessionInfo.title || 'AI Interview';
  } catch(e) {
      dom.sessionTitle.textContent = 'Error loading session';
      dom.nextToTestBtn.disabled = true;
      dom.detailsError.textContent = `Error: ${e.message}`;
      dom.detailsError.classList.remove('hidden');
      return;
  }
  
  showView('details');
});
</script>
</body>
</html>