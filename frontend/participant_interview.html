<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Interview - Participant Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#6366f1',
            'primary-dark': '#4f46e5',
            'accent': '#ec4899',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .view-content { display: none !important; }
    .view-active { display: block !important; animation: slideUp 0.4s ease-out; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .is-listening #question-box {
      animation: pulse-glow 2s infinite;
      border-color: #ef4444;
    }
    .is-listening .recording-indicator {
      display: flex !important;
    }
    #proctor-warning, #end-confirmation-modal {
      animation: slideUp 0.2s ease-out;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-6 select-none">
  
  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

  <!-- Proctoring Warning Overlay -->
  <div id="proctor-warning" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center" style="z-index: 9999;">
    <div class="bg-white p-8 rounded-2xl max-w-md text-center shadow-2xl border-4 border-red-500 relative">
      <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4 animate-bounce"></i>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Proctoring Alert</h2>
      <p id="proctor-msg" class="text-gray-600 mb-6 font-medium">Focus lost or tab switched.</p>
      <button id="dismiss-warning-btn" class="bg-red-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-red-600 transition shadow-lg transform hover:scale-105">
        I Understand, Return to Test
      </button>
    </div>
  </div>

  <!-- End Test Confirmation Modal (NEW) -->
  <div id="end-confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center" style="z-index: 9998;">
    <div class="bg-white p-8 rounded-3xl max-w-sm w-full text-center shadow-2xl border border-gray-200 transform scale-100 transition-transform">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-sign-out-alt text-3xl text-red-600"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">End Interview?</h3>
      <p class="text-gray-500 mb-8">Are you sure you want to submit your responses? This action cannot be undone.</p>
      
      <div class="flex gap-3">
        <button id="cancel-end-btn" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">
          Cancel
        </button>
        <button id="confirm-end-btn" class="flex-1 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-xl hover:shadow-lg hover:scale-105 transition transform">
          End Test
        </button>
      </div>
    </div>
  </div>

  <div class="w-full max-w-5xl glass-effect rounded-3xl shadow-2xl p-8 md:p-12 relative">
    
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-gray-800 mb-2">AI Interview Portal</h1>
      <p id="session-job-title" class="text-xl font-semibold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">Loading Session...</p>
    </div>

    <!-- VIEW 1: Details Form -->
    <div id="view-details" class="view-content view-active">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center mb-6">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-xl flex items-center justify-center mr-3">
            <span class="text-white font-bold">1</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Your Information</h2>
        </div>
        
        <div id="details-error" class="hidden bg-red-50 border-2 border-red-200 text-red-600 p-4 rounded-xl mb-4 font-medium"></div>

        <div class="space-y-4">
          <input id="p-name" placeholder="Full Name *" type="text" 
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-0 outline-none transition-all"/>
          <input id="p-phone" placeholder="Phone Number (Optional)" type="tel" 
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-0 outline-none transition-all"/>
          <textarea id="p-other" placeholder="Additional details (Optional)" rows="3" 
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-0 outline-none transition-all"></textarea>
        </div>

        <button id="next-to-test-btn" class="w-full mt-6 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
          Continue to Equipment Test <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>
    </div>

    <!-- VIEW 2: Equipment Test -->
    <div id="view-test" class="view-content">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center mb-6">
          <div class="w-10 h-10 bg-gradient-to-br from-accent to-pink-600 rounded-xl flex items-center justify-center mr-3">
            <span class="text-white font-bold">2</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Equipment Check</h2>
        </div>
        
        <!-- Speaker Test -->
        <div class="bg-blue-50 p-6 rounded-2xl mb-6 border-2 border-blue-200 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-volume-up mr-2"></i> Speaker Test</h3>
                <button id="test-audio-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary-dark">Play Sound</button>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="speaker-check" class="w-5 h-5 text-primary rounded" />
                <label for="speaker-check" class="ml-2 text-gray-700">I heard it</label>
            </div>
        </div>

        <!-- Mic Test -->
        <div class="bg-orange-50 p-6 rounded-2xl mb-6 border-2 border-orange-200">
          <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-microphone mr-2"></i> Microphone Test</h3>
          <div class="flex gap-2 mb-3">
            <button id="start-mic-test-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm">Start Test</button>
            <button id="stop-mic-test-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hidden">Stop</button>
          </div>
          <p id="mic-test-status" class="text-xs text-gray-500 mb-2">Status: Ready</p>
          <div id="mic-test-transcript" class="bg-white p-3 rounded border h-16 overflow-y-auto text-sm text-gray-600 italic">...</div>
          <div class="flex items-center mt-3">
            <input type="checkbox" id="mic-check" class="w-5 h-5 text-primary rounded" disabled />
            <label for="mic-check" class="ml-2 text-gray-700">Transcript appeared correctly</label>
          </div>
        </div>
        
        <button id="next-to-interview-btn" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-lg rounded-xl hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Start Interview <i class="fas fa-check-circle ml-2"></i>
        </button>
      </div>
    </div>

    <!-- VIEW 3: Interview -->
    <div id="view-interview" class="view-content">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Interview In Progress</h2>
          <p class="text-gray-500 text-sm">Candidate: <span id="participant-name">...</span></p>
        </div>
        <div class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-mono font-bold flex items-center">
          <i class="fas fa-clock mr-2"></i> <span id="remaining-time">--:--</span>
        </div>
      </div>

      <!-- Recording Indicator -->
      <div class="hidden justify-center mb-6 animate-bounce recording-indicator">
        <div class="bg-red-600 text-white px-4 py-1 rounded-full text-sm font-bold flex items-center shadow-lg">
          <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div> REC
        </div>
      </div>

      <!-- Question Box -->
      <div id="question-box" class="min-h-[160px] flex flex-col items-center justify-center text-center p-6 bg-indigo-50 border-4 border-transparent rounded-2xl transition-all mb-6">
        <p id="question-text" class="text-2xl font-bold text-gray-800">Preparing questions...</p>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-3 justify-center mb-6">
        <button id="start-btn" class="px-8 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-dark shadow-lg transition-all">
          Start Question
        </button>
        
        <button id="stop-btn" class="px-8 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-lg transition-all hidden">
          Stop & Submit
        </button>
        
        <button id="end-test-btn" class="px-6 py-3 bg-gray-700 text-white font-semibold rounded-xl hover:bg-gray-800 ml-auto">
          <i class="fas fa-power-off mr-2"></i> End Test
        </button>
      </div>

      <!-- Transcript -->
      <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 min-h-[100px]">
        <p class="text-xs text-gray-500 font-bold uppercase mb-2">Your Answer (Live Transcript):</p>
        <div id="answer-box" class="text-gray-700 whitespace-pre-wrap"></div>
      </div>
    </div>

    <!-- VIEW 4: Complete -->
    <div id="view-complete" class="view-content text-center py-10">
      <div class="bg-green-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check text-5xl text-green-600"></i>
      </div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Interview Submitted!</h2>
      <p class="text-gray-600 mb-8">Thank you. Your responses have been sent for AI evaluation.</p>
      <div class="p-4 bg-blue-50 text-blue-800 rounded-lg inline-block">
        You may now safely close this window.
      </div>
    </div>

  </div>

<script>
// --- CONFIGURATION ---
const API_BASE = "http://localhost:8000"; 
const MAX_VIOLATIONS = 10; // Maximum violations allowed before termination

// --- UTILITIES ---
function qs(name) { return new URLSearchParams(window.location.search).get(name); }
const token = qs('token');
const participant_id = qs('participant_id');
const session_id = qs('session_id');

// --- STATE MANAGEMENT ---
const state = {
  questions: [],
  qIndex: -1,
  recognition: null,
  isListening: false,
  remainingSeconds: 0,
  timerInterval: null,
  isTerminating: false,
  violationCount: 0,
  hasProctorWarning: false
};

// --- DOM ELEMENTS ---
const dom = {
  views: {
    details: document.getElementById('view-details'),
    test: document.getElementById('view-test'),
    interview: document.getElementById('view-interview'),
    complete: document.getElementById('view-complete')
  },
  // Details
  pName: document.getElementById('p-name'),
  pPhone: document.getElementById('p-phone'),
  pOther: document.getElementById('p-other'),
  btnNextToTest: document.getElementById('next-to-test-btn'),
  detailsError: document.getElementById('details-error'),
  sessionTitle: document.getElementById('session-job-title'),
  // Test
  btnTestAudio: document.getElementById('test-audio-btn'),
  btnMicStart: document.getElementById('start-mic-test-btn'),
  btnMicStop: document.getElementById('stop-mic-test-btn'),
  micTranscript: document.getElementById('mic-test-transcript'),
  micStatus: document.getElementById('mic-test-status'),
  checkSpeaker: document.getElementById('speaker-check'),
  checkMic: document.getElementById('mic-check'),
  btnNextToInterview: document.getElementById('next-to-interview-btn'),
  // Interview
  participantName: document.getElementById('participant-name'),
  remainingTime: document.getElementById('remaining-time'),
  questionText: document.getElementById('question-text'),
  answerBox: document.getElementById('answer-box'),
  btnStart: document.getElementById('start-btn'),
  btnStop: document.getElementById('stop-btn'),
  btnEndTest: document.getElementById('end-test-btn'),
  // Proctoring
  proctorWarning: document.getElementById('proctor-warning'),
  proctorMsg: document.getElementById('proctor-msg'),
  btnDismissWarning: document.getElementById('dismiss-warning-btn'),
  // End Confirmation Modal
  endConfirmationModal: document.getElementById('end-confirmation-modal'),
  btnConfirmEnd: document.getElementById('confirm-end-btn'),
  btnCancelEnd: document.getElementById('cancel-end-btn'),
  
  body: document.body
};

// --- API HELPER (STRICT) ---
async function apiPost(path, body) {
  const res = await fetch(API_BASE + path, {
    method: 'POST', 
    headers: {'Content-Type': 'application/json'}, 
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`API Error: ${txt}`);
  }
  return res.json();
}

// --- API HELPER (SAFE - For Logging only) ---
async function apiPostSafe(path, body) {
  try {
    await apiPost(path, body);
  } catch(e) {
    console.warn("Safe API Call Failed:", e);
  }
}

function showView(name) {
  Object.values(dom.views).forEach(v => v.classList.remove('view-active'));
  if(dom.views[name]) dom.views[name].classList.add('view-active');
}

function showToast(msg, type='error') {
  const div = document.createElement('div');
  div.className = `p-4 mb-2 rounded-lg text-white shadow-lg ${type==='error'?'bg-red-600':'bg-green-600'}`;
  div.innerHTML = msg;
  document.getElementById('toast-container').appendChild(div);
  setTimeout(()=>div.remove(), 4000);
}

// --- PROCTORING LOGIC ---
function setupProctoring() {
  // 1. Tab Switch
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !state.isTerminating) {
      triggerViolation("TAB_SWITCH", "Tab switching is forbidden.");
    }
  });

  // 2. Focus Lost
  window.addEventListener('blur', () => {
    if (!state.isTerminating && !state.hasProctorWarning) {
      triggerViolation("FOCUS_LOST", "Keep the interview window focused.");
    }
  });

  // 3. Anti-Copy/Paste
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'v')) {
      e.preventDefault();
      showToast("Copy/Paste disabled", "error");
      triggerViolation("COPY_PASTE", "Copy/Paste shortcut detected.");
    }
  });

  document.addEventListener('contextmenu', e => {
    e.preventDefault();
    showToast("Right-click disabled", "error");
  });
  
  // Dismiss button logic
  dom.btnDismissWarning.addEventListener('click', () => {
    dom.proctorWarning.classList.add('hidden');
    state.hasProctorWarning = false;
    try { document.documentElement.requestFullscreen(); } catch(e){}
  });
}

function triggerViolation(type, msg) {
  if(state.isTerminating) return;
  state.violationCount++;
  
  // Log safely
  apiPostSafe('/api/proctor/logs', {
    participant_id: participant_id,
    logs: [{
      type: type,
      detail: msg,
      timestamp: new Date().toISOString(),
      question_id: state.questions[state.qIndex]?.id || 'SETUP'
    }]
  });

  // CHECK LIMIT
  if (state.violationCount >= MAX_VIOLATIONS) {
      dom.proctorWarning.classList.add('hidden'); // Hide warning overlay if open
      alert("Test Terminated: Maximum proctoring violations reached.");
      finishInterview();
      return;
  }

  // Show Warning
  state.hasProctorWarning = true;
  dom.proctorMsg.innerText = `${msg} (Violation #${state.violationCount}/${MAX_VIOLATIONS})`;
  dom.proctorWarning.classList.remove('hidden');
}


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', async () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("CRITICAL: Browser not supported. Use Google Chrome.");
    return;
  }

  if (!token || !participant_id || !session_id) {
    dom.sessionTitle.innerText = "Error: Invalid Link";
    dom.detailsError.innerHTML = "Missing URL parameters. Check your invite link.";
    dom.detailsError.classList.remove('hidden');
    dom.btnNextToTest.disabled = true;
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/sessions/${session_id}/info`);
    if(res.ok) {
      const data = await res.json();
      dom.sessionTitle.innerText = data.title;
    }
  } catch(e) {
    dom.sessionTitle.innerText = "Backend Offline";
    showToast("Backend unreachable", "error");
  }
});

// --- STEP 1: DETAILS ---
dom.btnNextToTest.addEventListener('click', async () => {
  const name = dom.pName.value.trim();
  if(!name) { showToast("Name is required"); return; }
  
  dom.btnNextToTest.innerHTML = "Saving...";
  dom.btnNextToTest.disabled = true;

  try {
    await apiPost(`/api/participants/${participant_id}/profile`, {
      name: name,
      phone_number: dom.pPhone.value || null,
      other_details: dom.pOther.value || null
    });
    dom.participantName.innerText = name;
    showView('test');
  } catch(e) {
    alert("Failed to save profile: " + e.message);
    dom.btnNextToTest.disabled = false;
    dom.btnNextToTest.innerHTML = "Continue ->";
  }
});

// --- STEP 2: TEST ---
dom.btnTestAudio.addEventListener('click', () => {
  const u = new SpeechSynthesisUtterance("Audio check.");
  window.speechSynthesis.speak(u);
});

let micTestRec = null;
dom.btnMicStart.addEventListener('click', () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  micTestRec = new SpeechRecognition();
  micTestRec.continuous = true;
  micTestRec.interimResults = true;
  micTestRec.onstart = () => {
    dom.micStatus.innerText = "Listening...";
    dom.btnMicStart.classList.add('hidden');
    dom.btnMicStop.classList.remove('hidden');
  };
  micTestRec.onresult = e => {
    let t = '';
    for(let i=e.resultIndex; i<e.results.length; i++) t += e.results[i][0].transcript;
    dom.micTranscript.innerText = t;
  };
  micTestRec.start();
});

dom.btnMicStop.addEventListener('click', () => {
  if(micTestRec) micTestRec.stop();
  dom.micStatus.innerText = "Stopped";
  dom.btnMicStart.classList.remove('hidden');
  dom.btnMicStop.classList.add('hidden');
  dom.checkMic.disabled = false;
});

function checkReady() {
  dom.btnNextToInterview.disabled = !(dom.checkSpeaker.checked && dom.checkMic.checked);
}
dom.checkSpeaker.addEventListener('change', checkReady);
dom.checkMic.addEventListener('change', checkReady);

// --- STEP 3: START INTERVIEW ---
dom.btnNextToInterview.addEventListener('click', async () => {
  dom.btnNextToInterview.innerHTML = "Starting...";
  dom.btnNextToInterview.disabled = true;

  try {
    setupProctoring();
    try { await document.documentElement.requestFullscreen(); } catch(e){}

    // CRITICAL: Start Session
    const data = await apiPost(`/api/sessions/${session_id}/start`, { token });
    
    if(!data.questions || data.questions.length === 0) {
      throw new Error("No questions returned from server.");
    }

    state.questions = data.questions;
    state.remainingSeconds = (data.time_limit_minutes || 60) * 60;

    // Start Timer
    state.timerInterval = setInterval(() => {
      state.remainingSeconds--;
      const m = Math.floor(state.remainingSeconds/60);
      const s = state.remainingSeconds%60;
      dom.remainingTime.innerText = `${m}:${s<10?'0'+s:s}`;
      if(state.remainingSeconds <= 0) finishInterview(true);
    }, 1000);

    setupRecognition();
    showView('interview');
    dom.btnStart.innerText = "Start Question 1";

  } catch(e) {
    alert("Cannot start interview: " + e.message);
    dom.btnNextToInterview.disabled = false;
    dom.btnNextToInterview.innerHTML = "Start Interview";
  }
});

// --- SPEECH & QUESTION LOGIC ---
function setupRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  state.recognition = new SpeechRecognition();
  state.recognition.continuous = true;
  state.recognition.interimResults = true;

  state.recognition.onstart = () => {
    state.isListening = true;
    dom.body.classList.add('is-listening');
  };
  state.recognition.onend = () => {
    state.isListening = false;
    dom.body.classList.remove('is-listening');
    if(dom.btnStop.style.display !== 'none' && !state.isTerminating) {
      try { state.recognition.start(); } catch(e){}
    }
  };
  state.recognition.onresult = e => {
    let final = '', interim = '';
    for(let i=e.resultIndex; i<e.results.length; i++) {
      if(e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const prev = dom.answerBox.dataset.prev || '';
    if(final) dom.answerBox.dataset.prev = prev + final + ' ';
    dom.answerBox.innerText = (dom.answerBox.dataset.prev || '') + interim;
  };
}

dom.btnStart.addEventListener('click', nextQuestion);

async function nextQuestion() {
  if(state.qIndex >= state.questions.length - 1) {
    finishInterview();
    return;
  }

  state.qIndex++;
  const q = state.questions[state.qIndex];

  dom.questionText.innerText = `Q${state.qIndex+1}: ${q.text}`;
  dom.answerBox.innerText = "Listening...";
  dom.answerBox.dataset.prev = "";
  dom.btnStart.classList.add('hidden');
  dom.btnStop.classList.remove('hidden');

  const u = new SpeechSynthesisUtterance(q.text);
  u.onend = () => { try { state.recognition.start(); } catch(e){} };
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

dom.btnStop.addEventListener('click', async () => {
  state.recognition.stop();
  dom.btnStop.classList.add('hidden');
  dom.btnStart.classList.remove('hidden');

  const answer = dom.answerBox.innerText;
  const qId = state.questions[state.qIndex].id;

  // Safe save
  apiPostSafe(`/api/participants/${participant_id}/answer`, {
    question_id: qId,
    transcript: answer
  });

  if(state.qIndex >= state.questions.length - 1) {
    dom.btnStart.innerText = "Finish Interview";
    dom.btnStart.classList.replace('bg-primary', 'bg-green-600');
  } else {
    dom.btnStart.innerText = "Next Question";
  }
});

// --- FINISH LOGIC (Styled Modal) ---

// Show modal on click
dom.btnEndTest.addEventListener('click', () => {
    dom.endConfirmationModal.classList.remove('hidden');
});

// Cancel action
dom.btnCancelEnd.addEventListener('click', () => {
    dom.endConfirmationModal.classList.add('hidden');
});

// Confirm action
dom.btnConfirmEnd.addEventListener('click', async () => {
    dom.endConfirmationModal.classList.add('hidden');
    await finishInterview();
});


async function finishInterview(isTimeout=false) {
  if(state.isTerminating) return;
  state.isTerminating = true;

  clearInterval(state.timerInterval);
  if(state.recognition) state.recognition.stop();
  if(document.fullscreenElement) document.exitFullscreen();

  dom.btnEndTest.innerText = "Finishing...";
  dom.btnEndTest.disabled = true;

  try {
    await apiPost('/api/participants/' + participant_id + '/complete', {});
  } catch(e) {
    console.warn("Finish API failed:", e);
  } finally {
    showView('complete');
  }
}
</script>
</body>
</html>